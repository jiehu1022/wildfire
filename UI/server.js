/**
 * server.js
 *
 * Works in the local development environment and when deployed. If successful,
 * shows a single web page with the SRTM DEM displayed in a Google Map. See
 * accompanying README file for instructions on how to set up authentication.
 */
const ee = require('@google/earthengine');
const express = require('express');
const handlebars  = require('express-handlebars');

const app = express()
  .engine('.hbs', handlebars({extname: '.hbs', cache: false}))
  .set('view engine', '.hbs')
  .use('/static', express.static('static'))
  .use('/images', express.static('views/images'))
  .use('/videos', express.static('views/videos'))
  .get('/', (request, response) => {
      var l8 = ee.ImageCollection("LANDSAT/LC08/C01/T1_TOA"),
          grid = /* color: #000000 */ee.Geometry.MultiPoint(),
          grid2 = /* color: #808080 */ee.Geometry.MultiLineString(
              [[[-115.97250317983023, 32.069855643066916]]]);
      const image = ee.Image(l8.filterBounds(ee.Geometry.Point( -117.1611, 32.7157))
          .filterDate('2018-08-08', '2018-08-09')
          .sort('CLOUD_COVER')
          .first());
     // var image = ee.Image('LANDSAT/LC08/C01/T1_TOA/LC08_044034_20140318');
     /* var nir = image.select('B5');
      var red = image.select('B4');
      var ndvi = nir.subtract(red).divide(nir.add(red)).rename('NDVI');
      var ndvi_band = image.addBands(ndvi).select('NDVI');
      console.log(ndvi_band);
      var ndviParams = {bands: ndvi_band, min: -1, max: 1, palette: ['blue', 'white', 'green']};
// Define the visualization parameters.*/
      var vizParams = {
          bands: ['B7','B6', 'B4'],
          min: 0,
          max: 0.5,
          gamma: [0.95, 1.1, 1]
      };
      var visParams = {bands: ['B4', 'B3', 'B2'], max: 0.3};

      image.getMap(vizParams, ({mapid, token}) => {
       // console.log(mapid);
        response.render('index', {layout: false, mapid, token});
    });



  });

// Private key, in `.json` format, for an Earth Engine service account.
const PRIVATE_KEY = require('./privatekey.json');
const PORT =3001;

console.log('Authenticating server-side EE API calls via private key...');

ee.data.authenticateViaPrivateKey(
    PRIVATE_KEY,
    () => {
      console.log('Authentication succeeded.');
      ee.initialize(
          null, null,
          () => {
            console.log('Successfully initialized the EE client library.');
            app.listen(PORT);
            console.log(`Listening on port ${PORT}`);
          },
          (err) => {
            console.log(err);
            console.log(
                `Please make sure you have created a service account and have been approved.
Visit https://developers.google.com/earth-engine/service_account#how-do-i-create-a-service-account to learn more.`);
          });
    },
    (err) => {

      console.log(err);
    });




/** Experiments for creating grid */
function createGrid() {
    var geometry = /* color: #d63000 */ee.Geometry.Polygon(
        [[[-118.41571129999998, 34.22310464], [-118.413402, 34.08461985], [-118.4111084, 33.94613179], [-118.4088303, 33.80764048],
            [-118.4065678, 33.66914592], [-118.4043207, 33.53064812], [-118.4020889, 33.39214708], [-118.3998723, 33.25364282],
            [-118.39767090000001, 33.11513533], [-118.3954844, 32.97662464], [-118.3933129, 32.83811074], [-118.3911562, 32.69959364],
            [-118.3890142, 32.56107335], [-118.3868869, 32.42254988], [-118.38477409999999, 32.28402324], [-118.38267579999999, 32.14549343],
            [-118.2489899, 34.22491621], [-118.2469523, 34.08642208],
            [-118.24492859999998, 33.9479247],
            [-118.24291869999999, 33.80942411], [-118.24092240000002, 33.67092029], [-118.23893980000001, 33.53241326], [-118.2369706, 33.39390302], [-118.2350149, 33.25538958], [-118.2330725, 33.11687296],
            [-118.23114340000001, 32.97835315], [-118.2292274, 32.83983016], [-118.2273246, 32.701304], [-118.22543470000001, 32.56277468], [-118.2235577, 32.42424221],
            [-118.2216936, 32.28570659], [-118.2198422, 32.14716783], [-118.08225449999999, 34.22650119], [-118.0804888, 34.08799888],
            [-118.0787351, 33.94949335], [-118.0769933, 33.81098463], [-118.07526340000001, 33.67247271], [-118.07354529999999, 33.53395761],
            [-118.0718389, 33.39543932], [-118.0701442, 33.25691786], [-118.06846100000001, 33.11839323], [-118.0667892, 32.97986545],
            [-118.0651289, 32.84133451], [-118.06347990000002, 32.70280043], [-118.0618422, 32.56426321], [-118.06021570000001, 32.42572285],
            [-118.05860030000001, 32.28717938], [-118.056996, 32.14863279], [-117.915507, 34.22785951], [-117.9140132, 34.08935019],
            [-117.91252959999998, 33.95083768], [-117.9110561, 33.81232199], [-117.90959270000002, 33.67380313], [-117.9081392, 33.53528111],
            [-117.9066956, 33.39675592], [-117.9052619, 33.25822759], [-117.9038379, 33.11969611], [-117.9024237, 32.98116149],
            [-117.90101909999998, 32.84262373], [-117.8996241, 32.70408286], [-117.8982386, 32.56553886], [-117.89686259999999, 32.42699176],
            [-117.895496, 32.28844155], [-117.89413880000001, 32.14988825], [-117.7487492, 34.22899113], [-117.74752749999999, 34.09047597],
            [-117.74631409999998, 33.95195764], [-117.74510890000002, 33.81343615], [-117.7439119, 33.67491151], [-117.74272309999999, 33.53638372],
            [-117.74154240000001, 33.39785279], [-117.74036979999998, 33.25931872], [-117.73920509999999, 33.12078153],
            [-117.73804840000001, 32.98224121], [-117.7368996, 32.84369779], [-117.73575859999998, 32.70515125], [-117.73462549999999, 32.56660161],
            [-117.73350009999999, 32.42804889], [-117.73238229999998, 32.28949307], [-117.7312723, 32.15093418], [-117.5819831, 34.229896000000004],
            [-117.58103340000001, 34.09137617], [-117.5800902, 33.95285319], [-117.5791534, 33.81432706], [-117.578223, 33.67579779],
            [-117.577299, 33.53726539], [-117.57638119999999, 33.39872987], [-117.5754697, 33.26019122], [-117.57456440000001, 33.12164946],
            [-117.57366529999999, 32.98310459], [-117.5727723, 32.84455662], [-117.5718854, 32.70600556], [-117.57100459999998, 32.56745142],
            [-117.57012979999999, 32.42889419], [-117.56926100000001, 32.29033389], [-117.5683981, 32.15177052], [-117.4152105, 34.230574100000005],
            [-117.41453290000001, 34.09205077], [-117.41386000000001, 33.9535243], [-117.41319159999999, 33.81499469],
            [-117.41252779999999, 33.67646196], [-117.41186850000001, 33.5379261], [-117.4112137, 33.39938713], [-117.4105634, 33.26084505],
            [-117.4099175, 33.12229987], [-117.409276, 32.98375159], [-117.4086389, 32.84520022], [-117.4080061, 32.70664577],
            [-117.4073777, 32.56808824], [-117.40675359999999, 32.42952764], [-117.40613370000001, 32.29096398], [-117.40551809999998, 32.15239726],
            [-117.2484332, 34.23102538], [-117.24802779999999, 34.09249972], [-117.24762520000002, 33.95397093], [-117.2472252, 33.81543901],
            [-117.2468281, 33.67690398], [-117.24643359999999, 33.53836582], [-117.2460418, 33.39982456], [-117.2456527, 33.26128019],
            [-117.2452662, 33.12273273], [-117.24488240000001, 32.98418218], [-117.24450120000002, 32.84562855], [-117.2441226, 32.70707184],
            [-117.24374650000001, 32.56851206], [-117.24337309999999, 32.42994922], [-117.2430022, 32.29138332], [-117.2426338, 32.15281437],
            [-117.0816532, 34.23124985], [-117.0815199, 34.09272303], [-117.0813876, 33.95419309], [-117.0812561, 33.81566002],
            [-117.08112560000001, 33.67712383], [-117.0809959, 33.53858453], [-117.0808672, 33.40004213], [-117.08073929999999, 33.26149663],
            [-117.08061229999998, 33.12294803], [-117.0804861, 32.98439635], [-117.0803608, 32.8458416], [-117.0802364, 32.70728376],
            [-117.08011280000001, 32.56872287], [-117.07999, 32.43015891], [-117.07986809999998, 32.2915919], [-117.07974709999999, 32.15302184],
            [-116.9148722, 34.23124749], [-116.9150111, 34.09272068], [-116.9151491, 33.95419075], [-116.9152862, 33.81565769],
            [-116.9154223, 33.67712152], [-116.9155574, 33.53858223], [-116.91569170000001, 33.40003984], [-116.915825, 33.26149435], [-116.9159574, 33.12294577], [-116.91608899999999, 32.984394099999996], [-116.9162196, 32.84583935], [-116.91634930000001, 32.70728153], [-116.91647820000001, 32.56872065], [-116.9166061, 32.4301567], [-116.9167332, 32.2915897],
            [-116.9168595, 32.15301966], [-116.7480922, 34.23101829], [-116.74850330000001, 34.09249267], [-116.74891159999999, 33.95396392], [-116.74931709999998, 33.81543204], [-116.74971979999998, 33.67689703], [-116.75011979999998, 33.53835891],
            [-116.75051709999998, 33.39981769], [-116.7509117, 33.26127336], [-116.75130349999999, 33.12272593], [-116.75169270000002, 32.98417542], [-116.7520793, 32.84562182], [-116.7524632, 32.70706515], [-116.75284450000001, 32.5685054], [-116.75322309999999, 32.429942600000004], [-116.75359920000001, 32.29137673], [-116.75397269999999, 32.15280782], [-116.58131499999999, 34.23056228], [-116.5819983, 34.09203901], [-116.58267679999999, 33.953512599999996], [-116.58335079999999, 33.81498306], [-116.58402020000001, 33.67645039], [-116.58468500000001, 33.53791459], [-116.5853452, 33.39937568], [-116.586001, 33.26083366], [-116.58665230000001, 33.12228854], [-116.5872992, 32.98374032], [-116.5879416, 32.84518901], [-116.58857959999999, 32.70663461], [-116.5892133, 32.56807714], [-116.58984270000002, 32.4295166], [-116.59046780000001, 32.290953], [-116.5910885, 32.15238634], [-116.41454250000001, 34.22987946], [-116.4154979, 34.09135972], [-116.4164467, 33.95283682], [-116.41738909999998, 33.81431078], [-116.418325, 33.67578159], [-116.41925459999999, 33.53724928], [-116.42017790000001, 33.39871384], [-116.42109479999999, 33.26017527], [-116.4220055, 33.1216336], [-116.42291000000002, 32.98308881], [-116.42380829999999, 32.84454093], [-116.42470049999999, 32.70598995], [-116.42558659999999, 32.56743588], [-116.4264666, 32.42887874], [-116.4273406, 32.29031852], [-116.42820859999999, 32.15175524], [-116.24777659999998, 34.22896987], [-116.249004, 34.09045482], [-116.25022299999999, 33.9519366], [-116.2514338, 33.81341522], [-116.25263629999999, 33.67489068], [-116.25383059999999, 33.536363], [-116.2550168, 33.39783218], [-116.2561949, 33.25929822], [-116.2573649, 33.12076113], [-116.258527, 32.98222093], [-116.25968119999999, 32.8436776], [-116.2608274, 32.70513118], [-116.2619658, 32.56658165], [-116.2630965, 32.42802902], [-116.26421940000002, 32.28947331], [-116.26533459999999, 32.15091452], [-116.081019, 34.22783353], [-116.08251840000001, 34.08932434], [-116.0840077, 33.95081196], [-116.0854867, 33.81229641], [-116.0869557, 33.67377768], [-116.08841470000002, 33.53525579], [-116.0898638, 33.39673074], [-116.091303, 33.25820253], [-116.09273229999998, 33.11967118], [-116.09415200000001, 32.98113669], [-116.09556189999999, 32.84259907], [-116.0969622, 32.70405832], [-116.09835290000001, 32.56551446], [-116.0997341, 32.42696749], [-116.10110590000001, 32.28841741], [-116.1024683, 32.14986423], [-115.9142717, 34.22647048], [-115.91604309999998, 34.08796833], [-115.9178024, 33.94946296], [-115.91954979999998, 33.81095439], [-115.9212852, 33.67244263], [-115.9230088, 33.53392768], [-115.9247207, 33.39540955], [-115.9264209, 33.25688825], [-115.92810949999999, 33.11836378], [-115.92978659999999, 32.97983615], [-115.93145220000001, 32.84130536], [-115.9331065, 32.70277143], [-115.93474950000001, 32.56423437], [-115.93638119999999, 32.42569417], [-115.9380018, 32.28715084], [-115.9396112, 32.14860441], [-118.41571129999998, 34.22310464], [-118.413402, 34.08461985], [-118.4111084, 33.94613179], [-118.4088303, 33.80764048], [-118.4065678, 33.66914592], [-118.4043207, 33.53064812], [-118.4020889, 33.39214708], [-118.3998723, 33.25364282], [-118.39767090000001, 33.11513533], [-118.3954844, 32.97662464], [-118.3933129, 32.83811074], [-118.3911562, 32.69959364], [-118.3890142, 32.56107335], [-118.3868869, 32.42254988], [-118.38477409999999, 32.28402324], [-118.38267579999999, 32.14549343], [-118.2489899, 34.22491621], [-118.2469523, 34.08642208], [-118.24492859999998, 33.9479247], [-118.24291869999999, 33.80942411], [-118.24092240000002, 33.67092029], [-118.23893980000001, 33.53241326], [-118.2369706, 33.39390302], [-118.2350149, 33.25538958], [-118.2330725, 33.11687296], [-118.23114340000001, 32.97835315], [-118.2292274, 32.83983016], [-118.2273246, 32.701304], [-118.22543470000001, 32.56277468], [-118.2235577, 32.42424221], [-118.2216936, 32.28570659], [-118.2198422, 32.14716783], [-118.08225449999999, 34.22650119], [-118.0804888, 34.08799888], [-118.0787351, 33.94949335], [-118.0769933, 33.81098463], [-118.07526340000001, 33.67247271], [-118.07354529999999, 33.53395761], [-118.0718389, 33.39543932], [-118.0701442, 33.25691786], [-118.06846100000001, 33.11839323], [-118.0667892, 32.97986545], [-118.0651289, 32.84133451], [-118.06347990000002, 32.70280043], [-118.0618422, 32.56426321], [-118.06021570000001, 32.42572285], [-118.05860030000001, 32.28717938], [-118.056996, 32.14863279], [-117.915507, 34.22785951], [-117.9140132, 34.08935019], [-117.91252959999998, 33.95083768], [-117.9110561, 33.81232199], [-117.90959270000002, 33.67380313], [-117.9081392, 33.53528111], [-117.9066956, 33.39675592], [-117.9052619, 33.25822759], [-117.9038379, 33.11969611], [-117.9024237, 32.98116149], [-117.90101909999998, 32.84262373], [-117.8996241, 32.70408286], [-117.8982386, 32.56553886], [-117.89686259999999, 32.42699176], [-117.895496, 32.28844155], [-117.89413880000001, 32.14988825], [-117.7487492, 34.22899113], [-117.74752749999999, 34.09047597], [-117.74631409999998, 33.95195764], [-117.74510890000002, 33.81343615], [-117.7439119, 33.67491151], [-117.74272309999999, 33.53638372], [-117.74154240000001, 33.39785279], [-117.74036979999998, 33.25931872], [-117.73920509999999, 33.12078153], [-117.73804840000001, 32.98224121], [-117.7368996, 32.84369779], [-117.73575859999998, 32.70515125], [-117.73462549999999, 32.56660161], [-117.73350009999999, 32.42804889], [-117.73238229999998, 32.28949307], [-117.7312723, 32.15093418], [-117.5819831, 34.229896000000004], [-117.58103340000001, 34.09137617], [-117.5800902, 33.95285319], [-117.5791534, 33.81432706], [-117.578223, 33.67579779], [-117.577299, 33.53726539], [-117.57638119999999, 33.39872987], [-117.5754697, 33.26019122], [-117.57456440000001, 33.12164946], [-117.57366529999999, 32.98310459], [-117.5727723, 32.84455662], [-117.5718854, 32.70600556], [-117.57100459999998, 32.56745142], [-117.57012979999999, 32.42889419], [-117.56926100000001, 32.29033389], [-117.5683981, 32.15177052], [-117.4152105, 34.230574100000005], [-117.41453290000001, 34.09205077], [-117.41386000000001, 33.9535243], [-117.41319159999999, 33.81499469], [-117.41252779999999, 33.67646196], [-117.41186850000001, 33.5379261], [-117.4112137, 33.39938713], [-117.4105634, 33.26084505], [-117.4099175, 33.12229987], [-117.409276, 32.98375159], [-117.4086389, 32.84520022], [-117.4080061, 32.70664577], [-117.4073777, 32.56808824], [-117.40675359999999, 32.42952764], [-117.40613370000001, 32.29096398], [-117.40551809999998, 32.15239726], [-117.2484332, 34.23102538], [-117.24802779999999, 34.09249972], [-117.24762520000002, 33.95397093], [-117.2472252, 33.81543901], [-117.2468281, 33.67690398], [-117.24643359999999, 33.53836582], [-117.2460418, 33.39982456], [-117.2456527, 33.26128019], [-117.2452662, 33.12273273], [-117.24488240000001, 32.98418218], [-117.24450120000002, 32.84562855], [-117.2441226, 32.70707184], [-117.24374650000001, 32.56851206], [-117.24337309999999, 32.42994922], [-117.2430022, 32.29138332], [-117.2426338, 32.15281437], [-117.0816532, 34.23124985], [-117.0815199, 34.09272303], [-117.0813876, 33.95419309], [-117.0812561, 33.81566002], [-117.08112560000001, 33.67712383], [-117.0809959, 33.53858453], [-117.0808672, 33.40004213], [-117.08073929999999, 33.26149663], [-117.08061229999998, 33.12294803], [-117.0804861, 32.98439635], [-117.0803608, 32.8458416], [-117.0802364, 32.70728376], [-117.08011280000001, 32.56872287], [-117.07999, 32.43015891], [-117.07986809999998, 32.2915919], [-117.07974709999999, 32.15302184], [-116.9148722, 34.23124749], [-116.9150111, 34.09272068], [-116.9151491, 33.95419075], [-116.9152862, 33.81565769], [-116.9154223, 33.67712152], [-116.9155574, 33.53858223], [-116.91569170000001, 33.40003984], [-116.915825, 33.26149435], [-116.9159574, 33.12294577], [-116.91608899999999, 32.984394099999996], [-116.9162196, 32.84583935], [-116.91634930000001, 32.70728153], [-116.91647820000001, 32.56872065], [-116.9166061, 32.4301567], [-116.9167332, 32.2915897], [-116.9168595, 32.15301966], [-116.7480922, 34.23101829], [-116.74850330000001, 34.09249267], [-116.74891159999999, 33.95396392], [-116.74931709999998, 33.81543204], [-116.74971979999998, 33.67689703], [-116.75011979999998, 33.53835891], [-116.75051709999998, 33.39981769], [-116.7509117, 33.26127336], [-116.75130349999999, 33.12272593], [-116.75169270000002, 32.98417542], [-116.7520793, 32.84562182], [-116.7524632, 32.70706515], [-116.75284450000001, 32.5685054], [-116.75322309999999, 32.429942600000004], [-116.75359920000001, 32.29137673], [-116.75397269999999, 32.15280782], [-116.58131499999999, 34.23056228], [-116.5819983, 34.09203901], [-116.58267679999999, 33.953512599999996], [-116.58335079999999, 33.81498306], [-116.58402020000001, 33.67645039], [-116.58468500000001, 33.53791459], [-116.5853452, 33.39937568], [-116.586001, 33.26083366], [-116.58665230000001, 33.12228854], [-116.5872992, 32.98374032], [-116.5879416, 32.84518901], [-116.58857959999999, 32.70663461], [-116.5892133, 32.56807714], [-116.58984270000002, 32.4295166], [-116.59046780000001, 32.290953], [-116.5910885, 32.15238634], [-116.41454250000001, 34.22987946], [-116.4154979, 34.09135972], [-116.4164467, 33.95283682], [-116.41738909999998, 33.81431078], [-116.418325, 33.67578159], [-116.41925459999999, 33.53724928], [-116.42017790000001, 33.39871384], [-116.42109479999999, 33.26017527], [-116.4220055, 33.1216336], [-116.42291000000002, 32.98308881], [-116.42380829999999, 32.84454093], [-116.42470049999999, 32.70598995], [-116.42558659999999, 32.56743588], [-116.4264666, 32.42887874], [-116.4273406, 32.29031852], [-116.42820859999999, 32.15175524], [-116.24777659999998, 34.22896987], [-116.249004, 34.09045482], [-116.25022299999999, 33.9519366], [-116.2514338, 33.81341522], [-116.25263629999999, 33.67489068], [-116.25383059999999, 33.536363], [-116.2550168, 33.39783218], [-116.2561949, 33.25929822], [-116.2573649, 33.12076113], [-116.258527, 32.98222093], [-116.25968119999999, 32.8436776], [-116.2608274, 32.70513118], [-116.2619658, 32.56658165], [-116.2630965, 32.42802902], [-116.26421940000002, 32.28947331], [-116.26533459999999, 32.15091452], [-116.081019, 34.22783353], [-116.08251840000001, 34.08932434], [-116.0840077, 33.95081196], [-116.0854867, 33.81229641], [-116.0869557, 33.67377768], [-116.08841470000002, 33.53525579], [-116.0898638, 33.39673074], [-116.091303, 33.25820253], [-116.09273229999998, 33.11967118], [-116.09415200000001, 32.98113669], [-116.09556189999999, 32.84259907], [-116.0969622, 32.70405832], [-116.09835290000001, 32.56551446], [-116.0997341, 32.42696749], [-116.10110590000001, 32.28841741], [-116.1024683, 32.14986423], [-115.9142717, 34.22647048], [-115.91604309999998, 34.08796833], [-115.9178024, 33.94946296], [-115.91954979999998, 33.81095439], [-115.9212852, 33.67244263], [-115.9230088, 33.53392768], [-115.9247207, 33.39540955], [-115.9264209, 33.25688825], [-115.92810949999999, 33.11836378], [-115.92978659999999, 32.97983615], [-115.93145220000001, 32.84130536], [-115.9331065, 32.70277143], [-115.93474950000001, 32.56423437], [-115.93638119999999, 32.42569417], [-115.9380018, 32.28715084],
            [-115.9396112, 32.14860441]]]);
    return geometry;

}
function makeGrid(geometry, scale) {
    // pixelLonLat returns an image with each pixel labeled with longitude and
    // latitude values.
    var lonLat = ee.Image.pixelLonLat();
    // print(lonLat);
    // Select the longitude and latitude bands, multiply by a large number then
    // truncate them to integers.
    var lonGrid = lonLat
        .select('longitude')
        .multiply(10000000)
        .toInt();

    var latGrid = lonLat
        .select('latitude')
        .multiply(10000000)
        .toInt();

    // To produce the grid, multiply the latitude and longitude images and then use
    // reduce to vectors at the 10km resolution to group the grid into vectors.
    return lonGrid
        .multiply(latGrid)
        .reduceToVectors({
            geometry: geometry, // This is undefined until you draw a geometry.
            scale: scale,
            geometryType: 'polygon',
        });
}
function buildGeometryList(grid, limit) {
    return grid.toList(limit).map(function(feature) {
        var featureGeometry = ee.Feature(feature).geometry();
        var coordinates = featureGeometry.coordinates().get(0);
        return ee.Geometry.LinearRing(coordinates);
    });
}